<html>
<head>
	<meta charset='utf-8' />
	<title></title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
	<link href='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' rel='stylesheet' />		
	
	<script type="text/javascript" src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script type="text/javascript" src='https://api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js'></script>
	<script type="text/javascript" src="http://rawgithub.com/joergdietrich/Leaflet.Terminator/master/L.Terminator.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.6/socket.io.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>

	<style type="text/css">
		body { margin: 0px; padding: 0px; }
		#map {
			height: 1280px;
		}
	</style>
</head>
<body>
	<div id="map"></div>

	<script>
		var accessToken = 'pk.eyJ1IjoiZW5yaWNobWFuIiwiYSI6ImNpbzl6anEwYzAwMTZ2bW01c2I0bWNha2MifQ.CffLlUQBo77yPc5lJIKFBQ';
		// Replace 'mapbox.streets' with your map id.
		var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.dark/{z}/{x}/{y}.png?access_token=' + accessToken, {
			attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			style: 'mapbox://styles/mapbox/dark-v9'
		});

		var map = L.map('map')
			.addLayer(mapboxTiles)
			.setView([-60, 10], 2);

		var t = L.terminator();
		t.addTo(map);
		setInterval(function(){updateTerminator(t)}, 500);
		function updateTerminator(t) {
			var t2 = L.terminator();
			t.setLatLngs(t2.getLatLngs());
			t.redraw();
		}

		var markerize = function(tweet) {

            var coords = tweet.geo.coordinates;

			var icon = L.icon({  iconUrl: 'dot.png', iconSize: [15, 15] });
			var m = L.marker(coords, { icon: icon }).addTo(map);
            m.bindPopup("<b>@"+tweet.user.screen_name+"</b><br>"+tweet.text);

			m.setOpacity(0);
			$(m._icon).animate({opacity: 1}, {
				duration: 2000,
				step: function(obj) {
					console.log();
				},
				complete: function() {
						$(m._icon).animate({opacity: 0}, {
					duration: 600000,
					step: function(obj) {
						console.log();
					},
					complete: function() {
						map.removeLayer(m);
					}
				});
				}
			});
		};

		var socket = io();
		socket.on('tweet', function(tweet){
			console.log('Tweet arrived: ' + tweet.id + ' coords: '+tweet.geo.coordinates);
			markerize(tweet)
		});

	</script>
</body>
</html>