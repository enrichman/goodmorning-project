<html>
<head>
	<meta charset='utf-8' />
	<title></title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

	<link rel='stylesheet' href='//api.tiles.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' />
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
	<link rel='stylesheet' href='//api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.css' />
	
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
	<script type="text/javascript" src="//api.mapbox.com/mapbox-gl-js/v0.18.0/mapbox-gl.js"></script>
	<script type="text/javascript" src="//rawgithub.com/joergdietrich/Leaflet.Terminator/master/L.Terminator.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.6/socket.io.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>

	<style type="text/css">
		body { margin: 0px; padding: 0px; }
		#map {
			height: 1280px;
		}
        #name {
            position: absolute;
            z-index: 1000;
            color: #FFF;
            opacity: 0.5;
            margin-right: 10px;
            margin-top: 5px;
            font-family: sans-serif;
            width: 100%;
            text-align: right;
            font-size: small;
        }
	</style>
</head>
<body>
    <div id="name">Made with ❤ in Rome&nbsp;<br>by Enrico Candino&nbsp;&nbsp;&nbsp;&nbsp;<div></div></div>
	<div id="map"></div>

	<script>
		var accessToken = 'pk.eyJ1IjoiZW5yaWNobWFuIiwiYSI6ImNpbzl6anEwYzAwMTZ2bW01c2I0bWNha2MifQ.CffLlUQBo77yPc5lJIKFBQ';
		// Replace 'mapbox.streets' with your map id.
		var mapboxTiles = L.tileLayer('https://api.mapbox.com/v4/mapbox.dark/{z}/{x}/{y}.png?access_token=' + accessToken, {
			attribution: '© <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			style: 'mapbox://styles/mapbox/dark-v9'
		});

		var map = L.map('map')
			.addLayer(mapboxTiles)
			.setView([-60, 10], 2);

		var t = L.terminator();
		t.addTo(map);
		setInterval(function(){updateTerminator(t)}, 500);
		function updateTerminator(t) {
			var t2 = L.terminator();
			t.setLatLngs(t2.getLatLngs());
			t.redraw();
		}

		var markerize = function(tweet) {

            var coords = tweet.geo.coordinates;

			var icon = L.icon({  iconUrl: 'dot.png', iconSize: [15, 15] });
			var m = L.marker(coords, { icon: icon }).addTo(map);
            m.bindPopup("<b>@"+tweet.user.screen_name+"</b><br>"+tweet.text);

			m.setOpacity(0);
			$(m._icon).animate({opacity: 1}, {
				duration: 2000,
				step: function(obj) {
					console.log();
				},
				complete: function() {
						$(m._icon).animate({opacity: 0}, {
					duration: 600000,
					step: function(obj) {
						console.log();
					},
					complete: function() {
						map.removeLayer(m);
					}
				});
				}
			});
		};

		var socket = io();
		socket.on('tweet', function(tweet){
			console.log('Tweet arrived: ' + tweet.id + ' coords: '+tweet.geo.coordinates);
			markerize(tweet)
		});

	</script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-75265405-2', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>